(function () {
  'use strict';
  /* jshint undef: true, unused: true */
  /* globals QUnit, test, Rx, asyncTest, start, ok, equal, RSVP */

  QUnit.module('flatMap');

  var Observable = Rx.Observable,
      TestScheduler = Rx.TestScheduler,
      onNext = Rx.ReactiveTest.onNext,
      onError = Rx.ReactiveTest.onError,
      onCompleted = Rx.ReactiveTest.onCompleted,
      subscribe = Rx.ReactiveTest.subscribe,
      isEqual = Rx.internals.isEqual;

  asyncTest('flatMap then complete promise', function () {
    var xs = Rx.Observable.fromArray([4,3,2,1]);

    var ys = new RSVP.Promise(function (res) { res(42); });

    var results = [];
    xs.flatMap(ys).subscribe(
      function (x) {
        results.push(x);
      },
      function () {
        ok(false);
        start();
      },
      function () {
        ok(isEqual([42,42,42,42], results));
        start();
      });
  });

  asyncTest('flatMap then error Task', function () {
    var xs = Rx.Observable.fromArray([4,3,2,1]);

    var ys = new RSVP.Promise(function (res, rej) { rej(42); });

    xs.flatMap(ys).subscribe(
      function () {
        ok(false);
        start();
      },
      function (err) {
        equal(err, 42);
        start();
      },
      function () {
        ok(false);
        start();
      });
  });

  asyncTest('flatMap Selector complete Task', function () {
    var xs = Rx.Observable.fromArray([4,3,2,1]);

    var results = [];
    xs.flatMap(function (x, i) {
      return new RSVP.Promise(function (res) { res(x + i); });
    }).subscribe(
      function (x) {
        results.push(x);
      },
      function () {
        ok(false);
        start();
      },
      function () {
        ok(isEqual([4, 4, 4, 4], results));
        start();
      });
  });

  asyncTest('flatMap Selector error Task', function () {
    var xs = Rx.Observable.fromArray([4,3,2,1]);

    xs.flatMap(function (x, i) {
      return new RSVP.Promise(function (res, rej) { rej(x + i); });
    }).subscribe(
      function () {
        ok(false);
        start();
      },
      function (err) {
        equal(err, 4);
        start();
      },
      function () {
        ok(false);
        start();
      });
  });

  asyncTest('flatMap result selector complete promise', function () {
    var xs = Rx.Observable.fromArray([4,3,2,1]);

    var results = [];
    xs.flatMap(
      function (x, i) {
        return new RSVP.Promise(function (res) { res(x + i); });
      },
      function (x, y, i) {
        return x + y + i;
      })
      .subscribe(
        function (x) {
          results.push(x);
        },
        function () {
          ok(false);
          start();
        },
        function () {
          ok(isEqual([8, 8, 8, 8], results));
          start();
        });
  });

  asyncTest('flatMap result selector error promise', function () {
    var xs = Rx.Observable.fromArray([4,3,2,1]);

    xs.flatMap(
      function (x, i) {
        return new RSVP.Promise(function (res, rej) { rej(x + i); });
      },
      function (x, y, i) {
        return x + y + i;
      })
      .subscribe(
        function () {
          ok(false);
          start();
        },
        function (err) {
          equal(err, 4);
          start();
        },
        function () {
          ok(false);
          start();
        });
  });

  test('flatMap then complete complete', function () {
    var scheduler = new TestScheduler();

    var xs = scheduler.createColdObservable(
      onNext(100, 4),
      onNext(200, 2),
      onNext(300, 3),
      onNext(400, 1),
      onCompleted(500)
    );

    var ys = scheduler.createColdObservable(
      onNext(50, 'foo'),
      onNext(100, 'bar'),
      onNext(150, 'baz'),
      onNext(200, 'qux'),
      onCompleted(250)
    );

    var results = scheduler.startScheduler(function () {
      return xs.flatMap(ys);
    });

    results.messages.assertEqual(
      onNext(350, 'foo'),
      onNext(400, 'bar'),
      onNext(450, 'baz'),
      onNext(450, 'foo'),
      onNext(500, 'qux'),
      onNext(500, 'bar'),
      onNext(550, 'baz'),
      onNext(550, 'foo'),
      onNext(600, 'qux'),
      onNext(600, 'bar'),
      onNext(650, 'baz'),
      onNext(650, 'foo'),
      onNext(700, 'qux'),
      onNext(700, 'bar'),
      onNext(750, 'baz'),
      onNext(800, 'qux'),
      onCompleted(850)
      );

    xs.subscriptions.assertEqual(subscribe(200, 700));

    ys.subscriptions.assertEqual(
        subscribe(300, 550),
        subscribe(400, 650),
        subscribe(500, 750),
        subscribe(600, 850));
});

test('flatMap then complete Complete_2', function () {
    var scheduler = new TestScheduler();

    var xs = scheduler.createColdObservable(
      onNext(100, 4),
      onNext(200, 2),
      onNext(300, 3),
      onNext(400, 1),
      onCompleted(700));

    var ys = scheduler.createColdObservable(
      onNext(50, 'foo'),
      onNext(100, 'bar'),
      onNext(150, 'baz'),
      onNext(200, 'qux'),
      onCompleted(250));

    var results = scheduler.startScheduler(function () {
      return xs.flatMap(ys);
    });

    results.messages.assertEqual(
      onNext(350, 'foo'),
      onNext(400, 'bar'),
      onNext(450, 'baz'),
      onNext(450, 'foo'),
      onNext(500, 'qux'),
      onNext(500, 'bar'),
      onNext(550, 'baz'),
      onNext(550, 'foo'),
      onNext(600, 'qux'),
      onNext(600, 'bar'),
      onNext(650, 'baz'),
      onNext(650, 'foo'),
      onNext(700, 'qux'),
      onNext(700, 'bar'),
      onNext(750, 'baz'),
      onNext(800, 'qux'),
      onCompleted(900));

    xs.subscriptions.assertEqual(subscribe(200, 900));

    ys.subscriptions.assertEqual(
      subscribe(300, 550),
      subscribe(400, 650),
      subscribe(500, 750),
      subscribe(600, 850)
    );
  });

  test('flatMap then never complete', function () {
      var scheduler = new TestScheduler();

      var xs = scheduler.createColdObservable(
        onNext(100, 4),
        onNext(200, 2),
        onNext(300, 3),
        onNext(400, 1),
        onNext(500, 5),
        onNext(700, 0));

      var ys = scheduler.createColdObservable(
        onNext(50, 'foo'),
        onNext(100, 'bar'),
        onNext(150, 'baz'),
        onNext(200, 'qux'),
        onCompleted(250));

      var results = scheduler.startScheduler(function () {
          return xs.flatMap(ys);
      });

      results.messages.assertEqual(
        onNext(350, 'foo'),
        onNext(400, 'bar'),
        onNext(450, 'baz'),
        onNext(450, 'foo'),
        onNext(500, 'qux'),
        onNext(500, 'bar'),
        onNext(550, 'baz'),
        onNext(550, 'foo'),
        onNext(600, 'qux'),
        onNext(600, 'bar'),
        onNext(650, 'baz'),
        onNext(650, 'foo'),
        onNext(700, 'qux'),
        onNext(700, 'bar'),
        onNext(750, 'baz'),
        onNext(750, 'foo'),
        onNext(800, 'qux'),
        onNext(800, 'bar'),
        onNext(850, 'baz'),
        onNext(900, 'qux'),
        onNext(950, 'foo'));

      xs.subscriptions.assertEqual(subscribe(200, 1000));

      ys.subscriptions.assertEqual(
        subscribe(300, 550),
        subscribe(400, 650),
        subscribe(500, 750),
        subscribe(600, 850),
        subscribe(700, 950),
        subscribe(900, 1000));
  });

  test('flatMap then complete never', function () {
    var scheduler = new TestScheduler();

    var xs = scheduler.createColdObservable(
      onNext(100, 4),
      onNext(200, 2),
      onNext(300, 3),
      onNext(400, 1),
      onCompleted(500));

    var ys = scheduler.createColdObservable(
      onNext(50, 'foo'),
      onNext(100, 'bar'),
      onNext(150, 'baz'),
      onNext(200, 'qux'));

    var results = scheduler.startScheduler(function () {
      return xs.flatMap(ys);
    });

    results.messages.assertEqual(
      onNext(350, 'foo'),
      onNext(400, 'bar'),
      onNext(450, 'baz'),
      onNext(450, 'foo'),
      onNext(500, 'qux'),
      onNext(500, 'bar'),
      onNext(550, 'baz'),
      onNext(550, 'foo'),
      onNext(600, 'qux'),
      onNext(600, 'bar'),
      onNext(650, 'baz'),
      onNext(650, 'foo'),
      onNext(700, 'qux'),
      onNext(700, 'bar'),
      onNext(750, 'baz'), onNext(800, 'qux'));

    xs.subscriptions.assertEqual(subscribe(200, 700));

    ys.subscriptions.assertEqual(
      subscribe(300, 1000),
      subscribe(400, 1000),
      subscribe(500, 1000),
      subscribe(600, 1000)
    );
  });

  test('flatMap then complete Error', function () {
      var ex = new Error('ex');

      var scheduler = new TestScheduler();

      var xs = scheduler.createColdObservable(
        onNext(100, 4),
        onNext(200, 2),
        onNext(300, 3),
        onNext(400, 1),
        onCompleted(500));

      var ys = scheduler.createColdObservable(
        onNext(50, 'foo'),
        onNext(100, 'bar'),
        onNext(150, 'baz'),
        onNext(200, 'qux'),
        onError(300, ex));

      var results = scheduler.startScheduler(function () {
          return xs.flatMap(ys);
      });

      results.messages.assertEqual(
        onNext(350, 'foo'),
        onNext(400, 'bar'),
        onNext(450, 'baz'),
        onNext(450, 'foo'),
        onNext(500, 'qux'),
        onNext(500, 'bar'),
        onNext(550, 'baz'),
        onNext(550, 'foo'),
        onError(600, ex));

      xs.subscriptions.assertEqual(subscribe(200, 600));

      ys.subscriptions.assertEqual(subscribe(300, 600), subscribe(400, 600), subscribe(500, 600), subscribe(600, 600));
  });

  test('flatMap then error complete', function () {
    var ex = new Error('ex');

    var scheduler = new TestScheduler();

    var xs = scheduler.createColdObservable(
      onNext(100, 4),
      onNext(200, 2),
      onNext(300, 3),
      onNext(400, 1),
      onError(500, ex));

    var ys = scheduler.createColdObservable(
      onNext(50, 'foo'),
      onNext(100, 'bar'),
      onNext(150, 'baz'),
      onNext(200, 'qux'),
      onCompleted(250));

    var results = scheduler.startScheduler(function () {
      return xs.flatMap(ys);
    });

    results.messages.assertEqual(
      onNext(350, 'foo'),
      onNext(400, 'bar'),
      onNext(450, 'baz'),
      onNext(450, 'foo'),
      onNext(500, 'qux'),
      onNext(500, 'bar'),
      onNext(550, 'baz'),
      onNext(550, 'foo'),
      onNext(600, 'qux'),
      onNext(600, 'bar'),
      onNext(650, 'baz'),
      onNext(650, 'foo'),
      onError(700, ex));

    xs.subscriptions.assertEqual(subscribe(200, 700));

    ys.subscriptions.assertEqual(
      subscribe(300, 550),
      subscribe(400, 650),
      subscribe(500, 700),
      subscribe(600, 700));
  });

  test('flatMap then error Error', function () {
    var ex = new Error('ex');

    var scheduler = new TestScheduler();

    var xs = scheduler.createColdObservable(
      onNext(100, 4),
      onNext(200, 2),
      onNext(300, 3),
      onNext(400, 1),
      onError(500, ex));

    var ys = scheduler.createColdObservable(
      onNext(50, 'foo'),
      onNext(100, 'bar'),
      onNext(150, 'baz'),
      onNext(200, 'qux'),
      onError(250, ex));

    var results = scheduler.startScheduler(function () {
      return xs.flatMap(ys);
    });

    results.messages.assertEqual(
      onNext(350, 'foo'),
      onNext(400, 'bar'),
      onNext(450, 'baz'),
      onNext(450, 'foo'),
      onNext(500, 'qux'),
      onNext(500, 'bar'),
      onError(550, ex));

    xs.subscriptions.assertEqual(subscribe(200, 550));

    ys.subscriptions.assertEqual(
      subscribe(300, 550),
      subscribe(400, 550),
      subscribe(500, 550));
  });

  test('flatMap complete', function () {
    var scheduler = new TestScheduler();

    var xs = scheduler.createHotObservable(
      onNext(5, scheduler.createColdObservable(onError(1, new Error('ex1')))),
      onNext(105, scheduler.createColdObservable(onError(1, new Error('ex2')))),
      onNext(300, scheduler.createColdObservable(
        onNext(10, 102),
        onNext(90, 103),
        onNext(110, 104),
        onNext(190, 105),
        onNext(440, 106),
        onCompleted(460))),
      onNext(400, scheduler.createColdObservable(
        onNext(180, 202),
        onNext(190, 203),
        onCompleted(205))),
      onNext(550, scheduler.createColdObservable(
        onNext(10, 301),
        onNext(50, 302),
        onNext(70, 303),
        onNext(260, 304),
        onNext(310, 305),
        onCompleted(410))),
      onNext(750, scheduler.createColdObservable(onCompleted(40))),
      onNext(850, scheduler.createColdObservable(
        onNext(80, 401),
        onNext(90, 402),
        onCompleted(100))),
      onCompleted(900));

    var results = scheduler.startScheduler(function () {
      return xs.flatMap(function (x) {
        return x;
      });
    });

    results.messages.assertEqual(
      onNext(310, 102),
      onNext(390, 103),
      onNext(410, 104),
      onNext(490, 105),
      onNext(560, 301),
      onNext(580, 202),
      onNext(590, 203),
      onNext(600, 302),
      onNext(620, 303),
      onNext(740, 106),
      onNext(810, 304),
      onNext(860, 305),
      onNext(930, 401),
      onNext(940, 402),
      onCompleted(960));

    xs.subscriptions.assertEqual(subscribe(200, 900));

    xs.messages[2].value.value.subscriptions.assertEqual(subscribe(300, 760));
    xs.messages[3].value.value.subscriptions.assertEqual(subscribe(400, 605));
    xs.messages[4].value.value.subscriptions.assertEqual(subscribe(550, 960));
    xs.messages[5].value.value.subscriptions.assertEqual(subscribe(750, 790));
    xs.messages[6].value.value.subscriptions.assertEqual(subscribe(850, 950));
  });

  test('flatMap Complete_innerNotcomplete', function () {
    var scheduler = new TestScheduler();

    var xs = scheduler.createHotObservable(
      onNext(5, scheduler.createColdObservable(onError(1, new Error('ex1')))),
      onNext(105, scheduler.createColdObservable(onError(1, new Error('ex2')))),
      onNext(300, scheduler.createColdObservable(
        onNext(10, 102),
        onNext(90, 103),
        onNext(110, 104),
        onNext(190, 105),
        onNext(440, 106),
        onCompleted(460))),
      onNext(400, scheduler.createColdObservable(
        onNext(180, 202),
        onNext(190, 203))),
      onNext(550, scheduler.createColdObservable(
        onNext(10, 301),
        onNext(50, 302),
        onNext(70, 303),
        onNext(260, 304),
        onNext(310, 305),
        onCompleted(410))),
      onNext(750, scheduler.createColdObservable(onCompleted(40))),
      onNext(850, scheduler.createColdObservable(
        onNext(80, 401),
        onNext(90, 402),
        onCompleted(100))),
      onCompleted(900));

    var results = scheduler.startScheduler(function () {
      return xs.flatMap(function (x) {
        return x;
      });
    });

    results.messages.assertEqual(
      onNext(310, 102),
      onNext(390, 103),
      onNext(410, 104),
      onNext(490, 105),
      onNext(560, 301),
      onNext(580, 202),
      onNext(590, 203),
      onNext(600, 302),
      onNext(620, 303),
      onNext(740, 106),
      onNext(810, 304),
      onNext(860, 305),
      onNext(930, 401),
      onNext(940, 402));

    xs.subscriptions.assertEqual(subscribe(200, 900));

    xs.messages[2].value.value.subscriptions.assertEqual(subscribe(300, 760));
    xs.messages[3].value.value.subscriptions.assertEqual(subscribe(400, 1000));
    xs.messages[4].value.value.subscriptions.assertEqual(subscribe(550, 960));
    xs.messages[5].value.value.subscriptions.assertEqual(subscribe(750, 790));
    xs.messages[6].value.value.subscriptions.assertEqual(subscribe(850, 950));
  });

  test('flatMap Complete_outerNotcomplete', function () {
    var scheduler = new TestScheduler();

    var xs = scheduler.createHotObservable(
      onNext(5, scheduler.createColdObservable(onError(1, new Error('ex1')))),
      onNext(105, scheduler.createColdObservable(onError(1, new Error('ex2')))),
      onNext(300, scheduler.createColdObservable(
        onNext(10, 102),
        onNext(90, 103),
        onNext(110, 104),
        onNext(190, 105),
        onNext(440, 106),
        onCompleted(460))),
      onNext(400, scheduler.createColdObservable(
        onNext(180, 202),
        onNext(190, 203),
        onCompleted(205))),
      onNext(550, scheduler.createColdObservable(
        onNext(10, 301),
        onNext(50, 302),
        onNext(70, 303),
        onNext(260, 304),
        onNext(310, 305),
        onCompleted(410))),
      onNext(750, scheduler.createColdObservable(onCompleted(40))),
      onNext(850, scheduler.createColdObservable(
        onNext(80, 401),
        onNext(90, 402),
        onCompleted(100))));

    var results = scheduler.startScheduler(function () {
      return xs.flatMap(function (x) {
        return x;
      });
    });

    results.messages.assertEqual(
      onNext(310, 102),
      onNext(390, 103),
      onNext(410, 104),
      onNext(490, 105),
      onNext(560, 301),
      onNext(580, 202),
      onNext(590, 203),
      onNext(600, 302),
      onNext(620, 303),
      onNext(740, 106),
      onNext(810, 304),
      onNext(860, 305),
      onNext(930, 401),
      onNext(940, 402));

    xs.subscriptions.assertEqual(subscribe(200, 1000));
    xs.messages[2].value.value.subscriptions.assertEqual(subscribe(300, 760));
    xs.messages[3].value.value.subscriptions.assertEqual(subscribe(400, 605));
    xs.messages[4].value.value.subscriptions.assertEqual(subscribe(550, 960));
    xs.messages[5].value.value.subscriptions.assertEqual(subscribe(750, 790));
    xs.messages[6].value.value.subscriptions.assertEqual(subscribe(850, 950));
  });

  test('flatMap error outer', function () {
      var ex = new Error('ex');

      var scheduler = new TestScheduler();

      var xs = scheduler.createHotObservable(
        onNext(5, scheduler.createColdObservable(onError(1, new Error('ex1')))),
        onNext(105, scheduler.createColdObservable(onError(1, new Error('ex2')))),
        onNext(300, scheduler.createColdObservable(
          onNext(10, 102),
          onNext(90, 103),
          onNext(110, 104),
          onNext(190, 105),
          onNext(440, 106),
          onCompleted(460))),
        onNext(400, scheduler.createColdObservable(
          onNext(180, 202),
          onNext(190, 203),
          onCompleted(205))),
        onNext(550, scheduler.createColdObservable(
          onNext(10, 301),
          onNext(50, 302),
          onNext(70, 303),
          onNext(260, 304),
          onNext(310, 305),
          onCompleted(410))),
        onNext(750, scheduler.createColdObservable(onCompleted(40))),
        onNext(850, scheduler.createColdObservable(
          onNext(80, 401),
          onNext(90, 402),
          onCompleted(100))),
        onError(900, ex));

      var results = scheduler.startScheduler(function () {
        return xs.flatMap(function (x) {
          return x;
        });
      });

      results.messages.assertEqual(
        onNext(310, 102),
        onNext(390, 103),
        onNext(410, 104),
        onNext(490, 105),
        onNext(560, 301),
        onNext(580, 202),
        onNext(590, 203),
        onNext(600, 302),
        onNext(620, 303),
        onNext(740, 106),
        onNext(810, 304),
        onNext(860, 305),
        onError(900, ex));

      xs.subscriptions.assertEqual(subscribe(200, 900));

      xs.messages[2].value.value.subscriptions.assertEqual(subscribe(300, 760));
      xs.messages[3].value.value.subscriptions.assertEqual(subscribe(400, 605));
      xs.messages[4].value.value.subscriptions.assertEqual(subscribe(550, 900));
      xs.messages[5].value.value.subscriptions.assertEqual(subscribe(750, 790));
      xs.messages[6].value.value.subscriptions.assertEqual(subscribe(850, 900));
  });

  test('flatMap error inner', function () {
      var ex = new Error('ex');

      var scheduler = new TestScheduler();

      var xs = scheduler.createHotObservable(
        onNext(5, scheduler.createColdObservable(onError(1, new Error('ex1')))),
        onNext(105, scheduler.createColdObservable(onError(1, new Error('ex2')))),
        onNext(300, scheduler.createColdObservable(
          onNext(10, 102),
          onNext(90, 103),
          onNext(110, 104),
          onNext(190, 105),
          onNext(440, 106),
          onError(460, ex))),
        onNext(400, scheduler.createColdObservable(
          onNext(180, 202),
          onNext(190, 203),
          onCompleted(205))),
        onNext(550, scheduler.createColdObservable(
          onNext(10, 301),
          onNext(50, 302),
          onNext(70, 303),
          onNext(260, 304),
          onNext(310, 305),
          onCompleted(410))),
        onNext(750, scheduler.createColdObservable(onCompleted(40))),
        onNext(850, scheduler.createColdObservable(
          onNext(80, 401),
          onNext(90, 402),
          onCompleted(100))),
        onCompleted(900));

      var results = scheduler.startScheduler(function () {
        return xs.flatMap(function (x) {
          return x;
        });
      });

      results.messages.assertEqual(
        onNext(310, 102),
        onNext(390, 103),
        onNext(410, 104),
        onNext(490, 105),
        onNext(560, 301),
        onNext(580, 202),
        onNext(590, 203),
        onNext(600, 302),
        onNext(620, 303),
        onNext(740, 106),
        onError(760, ex));

      xs.subscriptions.assertEqual(subscribe(200, 760));

      xs.messages[2].value.value.subscriptions.assertEqual(subscribe(300, 760));
      xs.messages[3].value.value.subscriptions.assertEqual(subscribe(400, 605));
      xs.messages[4].value.value.subscriptions.assertEqual(subscribe(550, 760));
      xs.messages[5].value.value.subscriptions.assertEqual(subscribe(750, 760));
      xs.messages[6].value.value.subscriptions.assertEqual();
  });

  test('flatMap dispose', function () {
    var scheduler = new TestScheduler();

    var xs = scheduler.createHotObservable(
      onNext(5, scheduler.createColdObservable(onError(1, new Error('ex1')))),
      onNext(105, scheduler.createColdObservable(onError(1, new Error('ex2')))),
      onNext(300, scheduler.createColdObservable(
        onNext(10, 102),
        onNext(90, 103),
        onNext(110, 104),
        onNext(190, 105),
        onNext(440, 106),
        onCompleted(460))),
      onNext(400, scheduler.createColdObservable(
        onNext(180, 202),
        onNext(190, 203),
        onCompleted(205))),
      onNext(550, scheduler.createColdObservable(
        onNext(10, 301),
        onNext(50, 302),
        onNext(70, 303),
        onNext(260, 304),
        onNext(310, 305),
        onCompleted(410))),
      onNext(750, scheduler.createColdObservable(onCompleted(40))),
      onNext(850, scheduler.createColdObservable(
        onNext(80, 401),
        onNext(90, 402),
        onCompleted(100))),
      onCompleted(900));

    var results = scheduler.startScheduler(function () {
        return xs.flatMap(function (x) { return x; });
    }, { disposed: 700 });

    results.messages.assertEqual(
      onNext(310, 102),
      onNext(390, 103),
      onNext(410, 104),
      onNext(490, 105),
      onNext(560, 301),
      onNext(580, 202),
      onNext(590, 203),
      onNext(600, 302),
      onNext(620, 303));

    xs.subscriptions.assertEqual(subscribe(200, 700));

    xs.messages[2].value.value.subscriptions.assertEqual(subscribe(300, 700));
    xs.messages[3].value.value.subscriptions.assertEqual(subscribe(400, 605));
    xs.messages[4].value.value.subscriptions.assertEqual(subscribe(550, 700));
    xs.messages[5].value.value.subscriptions.assertEqual();
    xs.messages[6].value.value.subscriptions.assertEqual();
  });

  test('flatMap Throw', function () {
    var invoked = 0;
    var ex = new Error('ex');

    var scheduler = new TestScheduler();

    var xs = scheduler.createHotObservable(
      onNext(5, scheduler.createColdObservable(onError(1, new Error('ex1')))),
      onNext(105, scheduler.createColdObservable(onError(1, new Error('ex2')))),
      onNext(300, scheduler.createColdObservable(
        onNext(10, 102),
        onNext(90, 103),
        onNext(110, 104),
        onNext(190, 105),
        onNext(440, 106),
        onCompleted(460))),
      onNext(400, scheduler.createColdObservable(
        onNext(180, 202),
        onNext(190, 203),
        onCompleted(205))),
      onNext(550, scheduler.createColdObservable(
        onNext(10, 301),
        onNext(50, 302),
        onNext(70, 303),
        onNext(260, 304),
        onNext(310, 305),
        onCompleted(410))),
      onNext(750, scheduler.createColdObservable(
        onCompleted(40))),
      onNext(850, scheduler.createColdObservable(
        onNext(80, 401),
        onNext(90, 402),
        onCompleted(100))),
      onCompleted(900));

    var results = scheduler.startScheduler(function () {
      return xs.flatMap(function (x) {
        invoked++;
        if (invoked === 3) { throw ex; }
        return x;
      });
    });

    results.messages.assertEqual(
      onNext(310, 102),
      onNext(390, 103),
      onNext(410, 104),
      onNext(490, 105),
      onError(550, ex)
    );

    xs.subscriptions.assertEqual(subscribe(200, 550));

    xs.messages[2].value.value.subscriptions.assertEqual(
      subscribe(300, 550)
    );

    xs.messages[3].value.value.subscriptions.assertEqual(
      subscribe(400, 550)
    );

    xs.messages[4].value.value.subscriptions.assertEqual();
    xs.messages[5].value.value.subscriptions.assertEqual();
    xs.messages[6].value.value.subscriptions.assertEqual();
  });

  test('flatMap UseFunction', function () {
    var scheduler = new TestScheduler();

    var xs = scheduler.createHotObservable(
      onNext(210, 4),
      onNext(220, 3),
      onNext(250, 5),
      onNext(270, 1),
      onCompleted(290)
    );

    var results = scheduler.startScheduler(function () {
      return xs.flatMap(function (x) {
        return Observable.interval(10, scheduler).select(function () {
          return x;
        }).take(x);
      });
    });

    results.messages.assertEqual(
      onNext(220, 4),
      onNext(230, 3),
      onNext(230, 4),
      onNext(240, 3),
      onNext(240, 4),
      onNext(250, 3),
      onNext(250, 4),
      onNext(260, 5),
      onNext(270, 5),
      onNext(280, 1),
      onNext(280, 5),
      onNext(290, 5),
      onNext(300, 5),
      onCompleted(300)
    );

    xs.subscriptions.assertEqual(
      subscribe(200, 290)
    );
  });

  function arrayRepeat(value, times) {
    var results = [];
    for(var i = 0; i < times; i++) {
      results.push(value);
    }
    return results;
  }

  test('flatMap iterable complete', function () {
    var scheduler = new TestScheduler();

    var xs = scheduler.createHotObservable(
      onNext(210, 2),
      onNext(340, 4),
      onNext(420, 3),
      onNext(510, 2),
      onCompleted(600)
    );

    var inners = [];

    var res = scheduler.startScheduler(function () {
      return xs.flatMap(function (x) {
        var ys = arrayRepeat(x, x);
        inners.push(ys);
        return ys;
      });
    });

    res.messages.assertEqual(
      onNext(210, 2),
      onNext(210, 2),
      onNext(340, 4),
      onNext(340, 4),
      onNext(340, 4),
      onNext(340, 4),
      onNext(420, 3),
      onNext(420, 3),
      onNext(420, 3),
      onNext(510, 2),
      onNext(510, 2),
      onCompleted(600)
    );

    xs.subscriptions.assertEqual(
      subscribe(200, 600)
    );

    equal(4, inners.length);
  });

  test('flatMap Iterable complete result selector', function () {
    var scheduler = new TestScheduler();

    var xs = scheduler.createHotObservable(
      onNext(210, 2),
      onNext(340, 4),
      onNext(420, 3),
      onNext(510, 2),
      onCompleted(600)
    );

    var res = scheduler.startScheduler(function () {
      return xs.flatMap(function (x) { return arrayRepeat(x, x); }, function (x, y) { return x + y; });
    });

    res.messages.assertEqual(
      onNext(210, 4),
      onNext(210, 4),
      onNext(340, 8),
      onNext(340, 8),
      onNext(340, 8),
      onNext(340, 8),
      onNext(420, 6),
      onNext(420, 6),
      onNext(420, 6),
      onNext(510, 4),
      onNext(510, 4),
      onCompleted(600)
    );

    xs.subscriptions.assertEqual(
      subscribe(200, 600)
    );
  });

  test('flatMap iterable Error', function () {
    var scheduler = new TestScheduler();

    var ex = new Error();

    var xs = scheduler.createHotObservable(
      onNext(210, 2),
      onNext(340, 4),
      onNext(420, 3),
      onNext(510, 2),
      onError(600, ex)
    );

    var res = scheduler.startScheduler(function () {
      return xs.flatMap(function (x) { return arrayRepeat(x, x); })
    });

    res.messages.assertEqual(
      onNext(210, 2),
      onNext(210, 2),
      onNext(340, 4),
      onNext(340, 4),
      onNext(340, 4),
      onNext(340, 4),
      onNext(420, 3),
      onNext(420, 3),
      onNext(420, 3),
      onNext(510, 2),
      onNext(510, 2),
      onError(600, ex)
    );

    xs.subscriptions.assertEqual(
      subscribe(200, 600)
    );
  });

  test('flatMap Iterable error result selector', function () {
    var scheduler = new TestScheduler();

    var ex = new Error();

    var xs = scheduler.createHotObservable(
      onNext(210, 2),
      onNext(340, 4),
      onNext(420, 3),
      onNext(510, 2),
      onError(600, ex)
    );

    var res = scheduler.startScheduler(function () {
      return xs.flatMap(function (x) { return arrayRepeat(x, x); }, function (x, y) { return x + y; });
    });

    res.messages.assertEqual(
      onNext(210, 4),
      onNext(210, 4),
      onNext(340, 8),
      onNext(340, 8),
      onNext(340, 8),
      onNext(340, 8),
      onNext(420, 6),
      onNext(420, 6),
      onNext(420, 6),
      onNext(510, 4),
      onNext(510, 4),
      onError(600, ex)
    );

    xs.subscriptions.assertEqual(
      subscribe(200, 600)
    );
  });

  test('flatMap iterable dispose', function () {
    var scheduler = new TestScheduler();

    var xs = scheduler.createHotObservable(
      onNext(210, 2),
      onNext(340, 4),
      onNext(420, 3),
      onNext(510, 2),
      onCompleted(600)
    );

    var res = scheduler.startScheduler(
      function () {
        return xs.flatMap(function (x) { return arrayRepeat(x, x); })
      },
      { disposed: 350 }
    );

    res.messages.assertEqual(
      onNext(210, 2),
      onNext(210, 2),
      onNext(340, 4),
      onNext(340, 4),
      onNext(340, 4),
      onNext(340, 4)
    );

    xs.subscriptions.assertEqual(
      subscribe(200, 350)
    );
  });

  test('flatMap iterable dispose result selector', function () {
    var scheduler = new TestScheduler();

    var xs = scheduler.createHotObservable(
      onNext(210, 2),
      onNext(340, 4),
      onNext(420, 3),
      onNext(510, 2),
      onCompleted(600)
    );

    var res = scheduler.startScheduler(
      function () {
        return xs.flatMap(function (x) { return arrayRepeat(x, x); }, function (x, y) { return x + y; });
      },
      { disposed: 350 }
    );

    res.messages.assertEqual(
      onNext(210, 4),
      onNext(210, 4),
      onNext(340, 8),
      onNext(340, 8),
      onNext(340, 8),
      onNext(340, 8)
    );

    xs.subscriptions.assertEqual(
      subscribe(200, 350)
    );
  });

  test('flatMap iterable selector throws', function () {
    var scheduler = new TestScheduler();

    var xs = scheduler.createHotObservable(
      onNext(210, 2),
      onNext(340, 4),
      onNext(420, 3),
      onNext(510, 2),
      onCompleted(600)
    );

    var invoked = 0;
    var ex = new Error();

    var res = scheduler.startScheduler(function () {
      return xs.flatMap(function (x) {
        invoked++;
        if (invoked === 3) { throw ex; }
        return arrayRepeat(x, x);
      });
    });

    res.messages.assertEqual(
        onNext(210, 2),
        onNext(210, 2),
        onNext(340, 4),
        onNext(340, 4),
        onNext(340, 4),
        onNext(340, 4),
        onError(420, ex)
    );

    xs.subscriptions.assertEqual(
        subscribe(200, 420)
    );

    equal(3, invoked);
  });

  test('flatMap iterable result selector throws', function () {
    var scheduler = new TestScheduler();

    var xs = scheduler.createHotObservable(
      onNext(210, 2),
      onNext(340, 4),
      onNext(420, 3),
      onNext(510, 2),
      onCompleted(600)
    );

    var ex = new Error();

    var inners = [];

    var res = scheduler.startScheduler(function () {
      return xs.flatMap(
        function (x) {
          var ys = arrayRepeat(x, x);
          inners.push(ys);
          return ys;
        },
        function (x, y) {
          if (x === 3) { throw ex; }
          return x + y;
        }
      );
    });

    res.messages.assertEqual(
      onNext(210, 4),
      onNext(210, 4),
      onNext(340, 8),
      onNext(340, 8),
      onNext(340, 8),
      onNext(340, 8),
      onError(420, ex)
    );

    xs.subscriptions.assertEqual(
      subscribe(200, 420)
    );

    equal(3, inners.length);
  });

  test('flatMap iterable selector throws result selector', function () {
    var scheduler = new TestScheduler();

    var xs = scheduler.createHotObservable(
      onNext(210, 2),
      onNext(340, 4),
      onNext(420, 3),
      onNext(510, 2),
      onCompleted(600)
    );

    var invoked = 0;
    var ex = new Error();

    var res = scheduler.startScheduler(function () {
      return xs.flatMap(
        function (x) {
          invoked++;
          if (invoked === 3) { throw ex; }
          return arrayRepeat(x, x);
        },
        function (x, y) { return x + y; }
      );
    });

    res.messages.assertEqual(
      onNext(210, 4),
      onNext(210, 4),
      onNext(340, 8),
      onNext(340, 8),
      onNext(340, 8),
      onNext(340, 8),
      onError(420, ex)
    );

    xs.subscriptions.assertEqual(
      subscribe(200, 420)
    );

    equal(3, invoked);
  });

}());
